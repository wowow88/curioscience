---
import fs from 'fs';
import Layout from '../layouts/Layout.astro';
import CategoryFilter from '../components/CategoryFilter.astro';
import TagFilter from '../components/TagFilter.astro';

const data = JSON.parse(fs.readFileSync('../../workspace/data/articles.json', 'utf-8'));
const categories = [...new Set(data.map(item => item.category))];
const tags = [...new Set(data.flatMap(item => item.tags))];

const url = new URL(Astro.request.url);
const selected = url.searchParams.get("category");
const tagParam = url.searchParams.get('tag');

const filtered = data.filter(a => {
  const catMatch = selected ? a.category === selected : true;
  const tagMatch = tagParam ? a.tags.includes(tagParam) : true;
  return catMatch && tagMatch;
});
---

<Layout>
  <main class="max-w-5xl mx-auto p-6">
    <h1 class="text-3xl font-bold mb-6">ðŸ§  CurioScience - Ciencia diaria</h1>
    <CategoryFilter categories={categories} />
    <TagFilter tags={tags} />
    <ul class="space-y-6">
      {filtered.map(article => (
        <li class="bg-white shadow-md p-4 rounded-xl border border-gray-200">
          <h2 class="text-xl font-semibold">{article.title_es}</h2>
          <p class="text-sm text-gray-600">{article.date} â€” {article.category}</p>
          <p class="mt-2 text-gray-800">{article.content_es.slice(0, 200)}...</p>
          <a href={article.source_url} class="text-blue-500 mt-2 inline-block">Leer fuente original</a>
        </li>
      ))}
    </ul>
  </main>
</Layout>