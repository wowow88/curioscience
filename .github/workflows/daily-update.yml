name: Daily Articles Update

on:
  workflow_dispatch:
  schedule:
    # Ejecuta cada d√≠a a las 05:15 UTC (~07:15 Europa/Madrid en verano)
    - cron: '15 5 * * *'

permissions:
  contents: write  # necesario para commit/push

concurrency:
  group: daily-articles-update
  cancel-in-progress: true

env:
  TZ: Europe/Madrid
  PY_JSON: workspace/astro/public/articles_py.json
  JS_JSON: workspace/astro/public/articles_js.json
  FINAL_JSON: workspace/astro/public/articles.json
  # No traduzcas en fetch para ahorrar cuota; lo har√° el backfill dedicado
  TRANSLATE_IN_FETCH: '0'
  DEEPL_SLEEP_MS: '1200'

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: ‚¨áÔ∏è Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # necesitamos historial para comparar tama√±os

      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: üì¶ Instalar dependencias Python (si existen)
        run: |
          set -euo pipefail
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            # fallback m√≠nimos (ajusta a tus scripts)
            pip install requests feedparser beautifulsoup4 python-dateutil
          fi

      - name: üü¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: üü© Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9
          run_install: false

      - name: üì¶ Instalar dependencias Node (pnpm - root y Astro)
        run: |
          set -euo pipefail
          if [ -f pnpm-lock.yaml ]; then
            if [ -f package.json ]; then pnpm install --frozen-lockfile; fi
            if [ -f workspace/astro/package.json ]; then pnpm -C workspace/astro install --frozen-lockfile || pnpm -C workspace/astro install; fi
          else
            # Fallback a npm si no hay lock de pnpm
            if [ -f package.json ]; then
              if [ -f package-lock.json ]; then npm ci; else npm install --no-audit --no-fund; fi
            fi
            if [ -f workspace/astro/package.json ]; then
              pushd workspace/astro
              if [ -f package-lock.json ]; then npm ci; else npm install --no-audit --no-fund; fi
              popd
            fi
          fi

            - name: üîë Exportar claves (opcional, seg√∫n scripts)
        if: ${{ secrets.DEEPL_API_KEY != '' || secrets.OPENAI_API_KEY != '' }}
        run: |
          echo "DEEPL_API_KEY=${{ secrets.DEEPL_API_KEY }}" >> $GITHUB_ENV
          echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> $GITHUB_ENV

      - name: üêç Ejecutar data_pipeline.py (genera articles_py.json)
        run: |
          set -euo pipefail
          python -V
          if [ -f data_pipeline.py ]; then
            python data_pipeline.py
          elif [ -f workspace/data_pipeline.py ]; then
            python workspace/data_pipeline.py
          else
            echo "‚ùå No se encontr√≥ data_pipeline.py" && exit 1
          fi

      - name: üü¶ Ejecutar fetch-articles.js (genera articles_js.json)
        run: |
          set -euo pipefail
          node -v
          if [ -f fetch-articles.js ]; then
            node fetch-articles.js
          elif [ -f workspace/fetch-articles.js ]; then
            node workspace/fetch-articles.js
          elif [ -f scripts/fetch-articles.js ]; then
            node scripts/fetch-articles.js
          elif [ -f workspace/scripts/fetch-articles.js ]; then
            node workspace/scripts/fetch-articles.js
          else
            echo "‚ùå No se encontr√≥ fetch-articles.js" && exit 1
          fi

      - name: üü¶ Ejecutar merge-articles.js (fusiona en articles.json)
        run: |
          set -euo pipefail
          if [ -f merge-articles.js ]; then
            node merge-articles.js
          elif [ -f workspace/merge-articles.js ]; then
            node workspace/merge-articles.js
          elif [ -f scripts/merge-articles.js ]; then
            node scripts/merge-articles.js
          elif [ -f workspace/scripts/merge-articles.js ]; then
            node workspace/scripts/merge-articles.js
          else
            echo "‚ùå No se encontr√≥ merge-articles.js" && exit 1
          fi

      - name: ‚úÖ Validaci√≥n r√°pida de archivos generados (logs + conteos)
        run: |
          set -euo pipefail
          for f in "$PY_JSON" "$JS_JSON" "$FINAL_JSON"; do
            echo "::group::Comprobando $f"
            test -s "$f" || (echo "‚ùå $f no existe o est√° vac√≠o" && exit 1)
            jq . "$f" >/dev/null
            count=$(jq 'length' "$f")
            echo "‚úîÔ∏è $f OK. Entradas: $count"
            echo "Primeras 3 entradas:"
            jq -c '.[0:3]' "$f" || true
            echo "::endgroup::"
          done

      - name: üîé Validar fusi√≥n: superset, sin duplicados y orden por fecha
        run: |
          set -euo pipefail
          mkdir -p scripts
          cat > scripts/validate-merge.js <<'JS'
          const fs = require('fs');
          const base = 'workspace/astro/public';
          const files = {
            py: `${base}/articles_py.json`,
            js: `${base}/articles_js.json`,
            merged: `${base}/articles.json`,
          };
          const dateField = 'date';
          const read = (p) => JSON.parse(fs.readFileSync(p, 'utf8'));
          const id = (it) => String((it.id||it.ID||it.doi||it.DOI||it.url||it.link||'').trim().toLowerCase().replace(/[\s?#]+/g,''));
          const t = (it) => { const d = it[dateField]||it.published||it.publishedAt||it.datePublished||''; const tt = Date.parse(d); return Number.isFinite(tt)?tt:0; };
          const assert = (c,m)=>{ if(!c){ console.error('‚ùå '+m); process.exit(1);} };
          const py = read(files.py);
          const js = read(files.js);
          const merged = read(files.merged);
          console.log(`PY: ${py.length} | JS: ${js.length} | MERGED: ${merged.length}`);
          const mergedIds = new Set(merged.map(id));
          const missPy = py.filter(x=>!mergedIds.has(id(x)));
          const missJs = js.filter(x=>!mergedIds.has(id(x)));
          if (missPy.length||missJs.length){
            console.error('Faltan entradas en articles.json');
            if(missPy.length) console.error('- De PY (ids):', missPy.map(id).slice(0,20));
            if(missJs.length) console.error('- De JS (ids):', missJs.map(id).slice(0,20));
            process.exit(1);
          } else {
            console.log('‚úîÔ∏è articles.json contiene todas las entradas de PY y JS.');
          }
          const seen = new Set(); const dups = [];
          for (const it of merged){ const k = id(it); if(seen.has(k)) dups.push(k); seen.add(k);} 
          assert(dups.length===0, `Duplicados en articles.json (ej.: ${dups.slice(0,20).join(', ')})`);
          console.log('‚úîÔ∏è Sin duplicados en articles.json.');
          let inOrder = true;
          for (let i=1;i<merged.length;i++){ if (t(merged[i])>t(merged[i-1])) { inOrder=false; break; } }
          assert(inOrder, `articles.json no est√° ordenado por fecha descendente.`);
          console.log('‚úîÔ∏è Orden correcto por fecha descendente.');
          console.log('‚ÑπÔ∏è Validaci√≥n completada.');
          JS
          node scripts/validate-merge.js

      - name: üõü Proteger hist√≥rico frente a regresiones (>20% menos que el commit previo)
        run: |
          set -euo pipefail
          CUR=$(jq 'length' "$FINAL_JSON")
          PREV=$(git show HEAD:"$FINAL_JSON" 2>/dev/null | jq 'length' || echo 0)
          echo "Anterior: $PREV | Actual: $CUR"
          if [ "$PREV" -gt 0 ]; then
            LIMITE=$(( PREV * 80 / 100 ))
            if [ "$CUR" -lt "$LIMITE" ]; then
              echo "‚ùå El total actual ($CUR) es >20% menor que el anterior ($PREV)." && exit 1
            fi
          fi

      - name: üèóÔ∏è Build Astro (opcional, si existe)
        if: ${{ hashFiles('workspace/astro/package.json') != '' }}
        working-directory: workspace/astro
        run: |
          if [ -f pnpm-lock.yaml ]; then pnpm run build; else npm run build; fi

      - name: üì¶ Subir artefactos (JSON intermedios y final)
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: articles-jsons
          path: |
            ${{ env.PY_JSON }}
            ${{ env.JS_JSON }}
            ${{ env.FINAL_JSON }}

      - name: üìù Commit & Push de art√≠culos
        run: |
          set -euo pipefail
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "$PY_JSON" "$JS_JSON" "$FINAL_JSON"
          if git diff --cached --quiet; then
            echo "Sin cambios que commitear."
          else
            git commit -m "chore: daily articles update [skip ci]"
            git push
          fi
