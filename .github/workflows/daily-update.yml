name: Daily Articles Update

on:
  workflow_dispatch: {}
  schedule:
    - cron: '15 5 * * *'  # 05:15 UTC (~07:15 Europe/Madrid en verano)

permissions:
  contents: write

concurrency:
  group: daily-articles-update
  cancel-in-progress: true

env:
  TZ: Europe/Madrid
  PY_JSON: workspace/astro/public/articles_py.json
  JS_JSON: workspace/astro/public/articles_js.json
  FINAL_JSON: workspace/astro/public/articles.json
  TRANSLATE_IN_FETCH: '0'
  DEEPL_SLEEP_MS: '1200'
  DEEPL_API_KEY: ${{ secrets.DEEPL_API_KEY }}
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Python deps
        run: |
          set -euo pipefail
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install requests feedparser beautifulsoup4 python-dateutil arxiv deep-translator
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9
          run_install: false

      - name: Install Node deps (pnpm if lock; else npm)
        run: |
          set -euo pipefail
          if [ -f pnpm-lock.yaml ]; then
            [ -f package.json ] && pnpm install --frozen-lockfile
            if [ -f workspace/astro/package.json ]; then
              pnpm -C workspace/astro install --frozen-lockfile || pnpm -C workspace/astro install
            fi
          else
            if [ -f package.json ]; then
              if [ -f package-lock.json ]; then npm ci; else npm install --no-audit --no-fund; fi
            fi
            if [ -f workspace/astro/package.json ]; then
              (cd workspace/astro && if [ -f package-lock.json ]; then npm ci; else npm install --no-audit --no-fund; fi)
            fi
          fi

      - name: Run data_pipeline.py → articles_py.json
        run: |
          set -euo pipefail
          python -V
          if [ -f data_pipeline.py ]; then
            python data_pipeline.py
          elif [ -f workspace/data_pipeline.py ]; then
            python workspace/data_pipeline.py
          elif [ -f scripts/data_pipeline.py ]; then
            python scripts/data_pipeline.py
          else
            echo "❌ No se encontró data_pipeline.py" && exit 1
          fi

      - name: Run fetch-articles.js → articles_js.json
        run: |
          set -euo pipefail
          node -v
          if [ -f scripts/fetch-articles.js ]; then
            node scripts/fetch-articles.js
          elif [ -f workspace/scripts/fetch-articles.js ]; then
            node workspace/scripts/fetch-articles.js
          elif [ -f fetch-articles.js ]; then
            node fetch-articles.js
          elif [ -f workspace/fetch-articles.js ]; then
            node workspace/fetch-articles.js
          else
            echo "❌ No se encontró fetch-articles.js" && exit 1
          fi

      - name: Run merge-articles.js → articles.json
        run: |
          set -euo pipefail
          if [ -f scripts/merge-articles.js ]; then
            node scripts/merge-articles.js
          elif [ -f workspace/scripts/merge-articles.js ]; then
            node workspace/scripts/merge-articles.js
          elif [ -f merge-articles.js ]; then
            node merge-articles.js
          elif [ -f workspace/merge-articles.js ]; then
            node workspace/merge-articles.js
          else
            echo "❌ No se encontró merge-articles.js" && exit 1
          fi

      - name: Quick check (existence)
        run: |
          set -euo pipefail
          for f in "$PY_JSON" "$JS_JSON" "$FINAL_JSON"; do
            test -s "$f" || (echo "❌ $f no existe o está vacío" && exit 1)
          done

      - name: Build Astro (if exists)
        if: ${{ hashFiles('workspace/astro/package.json') != '' }}
        working-directory: workspace/astro
        run: |
          if [ -f pnpm-lock.yaml ]; then pnpm run build; else npm run build; fi

      - name: Upload artifacts
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: articles-jsons
          path: |
            ${{ env.PY_JSON }}
            ${{ env.JS_JSON }}
            ${{ env.FINAL_JSON }}

      - name: Commit & Push
        run: |
          set -euo pipefail
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "$PY_JSON" "$JS_JSON" "$FINAL_JSON"
          if git diff --cached --quiet; then
            echo "Sin cambios que commitear."
          else
            git commit -m "chore: daily articles update [skip ci]"
            git push
          fi
